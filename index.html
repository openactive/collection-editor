<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <title>OpenActive Activity List ConceptCollection Editor</title>
    <style>
      body {
        font-family: Helvetica;
      }

      html,
      body {
        height: 100%;
        margin: 0px;
        padding: 0px;
      }

      textarea {
        width: 100%;
        height: 100%;
      }

      .container {
        display: flex;
        height: 100%;
        max-height: 100%;
      }

      .activity-list {
        flex: 1;
        padding: 1rem;
        overflow-y: scroll;
      }

      .meta {
        width: 100%;
      }

      #collection {
        flex: 1;
        padding: 1rem;
      }

    </style>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@openactive/skos/dist/skos.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      // This demo is based on https://neofusion.github.io/hierarchy-select/

      // Using source files:
      // - https://neofusion.github.io/hierarchy-select/v2/dist/hierarchy-select.min.js
      // - https://neofusion.github.io/hierarchy-select/v2/dist/hierarchy-select.min.css
      // - https://www.openactive.io/skos.js/dist/skos.min.js

      // ** Example of how to render a hierarchy from the activity list **

      function renderTree(concepts, level, parent) {
        var output = [];

        // Recursively .getNarrower() on concepts
        concepts.forEach(function(concept) {
          var label = concept.prefLabel;
          var hidden = "";
          // Include altLabels (e.g. Group Cycling) to make them visible to the user
          if (concept.altLabel && concept.altLabel.length > 0) {
            label = label + ' / ' + concept.altLabel.join(' / ')
          }
          // Include hiddenLabels (e.g. 5aside) as hidden so they will still match search terms
          if (concept.hiddenLabel && concept.hiddenLabel.length > 0) {
            hidden = concept.hiddenLabel.join(' / ')
          }

          // Use jQuery to escape all values when outputting HTML
          var li = $("<li/>", {
            "class": "dropdown-item",
            "data-value": concept.id,
            "data-hidden": hidden,
            "data-level": level,
            "href": "#",
            text: label
          });

          var checkbox = $("<input/>", {
            id: concept.id.substring(concept.id.indexOf('#') + 1),
            value: concept.id,
            class: 'concept-check',
            type: 'checkbox'
          });
          checkbox.prependTo(li);

          checkbox.click(renderCollection);
          $('#jsonId').bind("keyup change", renderCollection);
          $('#prefLabel').bind("keyup change", renderCollection);
          $('#definition').bind("keyup change", renderCollection);

          var narrower = concept.getNarrower();
          if (narrower) {
            var ul = $("<ul/>", {
              "class": "dropdown-item"
            });
            renderTree(narrower, level + 1, ul);
            ul.appendTo(li);
          }

          li.appendTo(parent);
        });
      }

      function renderCollection() {
        var collection = {
          "@context": "https://openactive.io/",
          "@type": "ConceptCollection",
          "@id": $('#jsonId').val(),
          "prefLabel": $('#prefLabel').val(),
          "inScheme": "https://openactive.io/activity-list",
          "license": "https://creativecommons.org/licenses/by/4.0/",
          "definition": $('#definition').val(),
          "member": $('.concept-check:checkbox:checked').map(function() {
            return $(this).val();
          }).get()
        };

        $("#collection").val(JSON.stringify(collection, null, 2));
      }

      $(function() {
        // Load the activity list
        // (note this file should be copied to your server on a nightly cron and served from there)
        $.getJSON('https://openactive.io/activity-list/activity-list.jsonld', function(data) {
          // Use SKOS.js to read the file (https://www.openactive.io/skos.js/)
          var scheme = new skos.ConceptScheme(data);

          // Render the activity list in a format the HierarchySelect will understand
          renderTree(scheme.getTopConcepts(), 1, $('#activity-list-dropdown'));
        });

        $('#download').click(function() {
          var id = $('#jsonId').val();

          var filename = id.substring(id.lastIndexOf('/') + 1) || "collection.json";

          download(filename, $("#collection").val());
        });

        $('#collection').on('input', function() {
          processFile();
        });
      });

      function processFile() {
        try {
          var collection = JSON.parse($("#collection").val());

          $('.concept-check').prop("checked", false);

          if (Array.isArray(collection.member)) {
            collection.member.forEach(function(id) {
              var identifier = id.substring(id.indexOf('#') + 1);

              $('#' + identifier).prop("checked", true);
            });
          }

          $('#jsonId').val(collection['@id'] || collection['id']);
          $('#prefLabel').val(collection['prefLabel']);
          $('#definition').val(collection['definition']);

        } catch (err) {
          alert(err);
        }
      }

      function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      }

      function openFile(event) {
        var input = event.target;

        var reader = new FileReader();
        reader.onload = function() {
          var text = reader.result;
          $("#collection").val(text);
          processFile();
        };
        reader.readAsText(input.files[0]);
      };

    </script>
  </head>

  <body>
    <div class="container">
      <div class="activity-list">
        <h1>OpenActive Activity List ConceptCollection Editor</h1>
        <p>
          Edit the ConceptCollection below, or paste in an existing ConceptCollection on the right hand side. Alternatively load a file using the "Choose file" button below.
        </p>
        <p>
          <input type='file' onchange='openFile(event)'>
        </p>
        <p>When you've finished, make sure you save your changes using the "Download" button.
        </p>
        <p>
          <button type="button" id="download">Download</button>
        </p>

        <p>
          <label for="jsonId">@id</label>
          <input class="meta" id="jsonId">
        </p>


        <p>
          <label for="prefLabel">prefLabel</label>
          <input class="meta" id="prefLabel">
        </p>

        <p>
          <label for="definition">definition</label>
          <input class="meta" id="definition">
        </p>

        <ul id="activity-list-dropdown">
        </ul>
      </div>

      <textarea id="collection"></textarea>
    </div>
  </body>

</html>
